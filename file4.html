<html>
<head>
</head>
<body>
<div id="stage"></div>
<script src="bonsai.js"></script>
<script src="jquery.js"></script>
<script>
var stage = document.getElementById('stage');
bonsai.run(stage, {
  plugins: ['http://demos.bonsaijs.org/demos/music/button.js'],
  width:180,
  height:190,
  code: function() {

    var RESOURCES_URL = 'http://demos.bonsaijs.org/demos/music/';
    var AUDIO_SRC = [
      {src: RESOURCES_URL + 'ClosingCredits.mp3'},
      {src: RESOURCES_URL + 'ClosingCredits.ogg'}
    ];
    var AUDIO_LENGTH = 45000;
    
    // SOUNDS FROM http://www.mediacollege.com/downloads/sound-effects/star-trek/tos/
    var animationDisc, wantsToPlay = false, audioLoaded = false;
    var audio = new bonsai.Audio(AUDIO_SRC).addTo(stage).on('load', function() {
      audioLoaded = true;
      if (wantsToPlay) {
        audio.play();
        animationDisc.play();
      }
    }).prepareUserEvent();
    
    var centerX = 88;
    var centerY = 93;
    
    (function drawButton() {
    
      var all = new Group().attr({
        x: centerX - (176/2),
        y: centerY - (176/2)
      }).addTo(stage);
    
      var disc = new Bitmap(RESOURCES_URL + 'CD.png').attr({
        origin: new Point(88, 87.5)
      });
      var spinner = new Bitmap(RESOURCES_URL + 'Spinner.png').attr({
        x: -5,
        y: -5,
        origin: new Point(94.5, 95)
      });
      var button = new Button(RESOURCES_URL).attr({
        x: 59,
        y: 59
      });
    
      animationDisc = new Animation('.6s', {
        rotation: Math.PI*2
      }, {
        repeat: Infinity
      }).addSubject(disc);
    
      button.on('play', function() {
        wantsToPlay = true;
    
        if (audioLoaded) {
          audio.play();
          animationDisc.play();
        } else {
          // Loading
          // console.log("Loading………");
        }
      });
      button.on('pause', function() {
        wantsToPlay = false;
        audio.pause();
        animationDisc.pause();
      });
    
      var currentTime = 0;
      var lastTickTime = +new Date;
    
      stage.on('tick', onTick);
    
      function onTick() {
        if (audioLoaded && button.isPlaying) {
          // Add to currentTime on every tick (estimating where the audio is at)
          currentTime += +new Date - lastTickTime;
        }
        lastTickTime = +new Date;
        spinner.attr('rotation', Math.PI*2*(currentTime/AUDIO_LENGTH));
        if (currentTime > AUDIO_LENGTH) {
          // Fade out controls at end of audio
          all.animate('.5s', { opacity: 0 });
          stage.removeListener('tick', onTick);
        }
      }
    
      disc.addTo(all);
      spinner.addTo(all);
      button.addTo(all);
    
      // Spinner scrubbing
    
      spinner.on('drag', function(e) {
        var x = e.stageX - centerX;
        var y = e.stageY - centerY;
        // Calculate angle:
        var a = Math.atan2(y, x);
        a += Math.PI/2; // Take quarter
        if (a < 0) a = Math.PI*2 + a; // Make it from 0..(Math.PI*2)
        currentTime = a / (Math.PI*2) * AUDIO_LENGTH;
        audio.attr('time', currentTime / 1000);
      });
    
    })();

  }
});

</script>
</body>
</html>